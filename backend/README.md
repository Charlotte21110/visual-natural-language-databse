# Natural Language DB Backend

åŸºäº LangChain.js + CloudBase çš„æ•°æ®åº“è‡ªç„¶è¯­è¨€äº¤äº’æœåŠ¡

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å‰ç«¯ (React)                   â”‚
â”‚  - ChatArea ç»„ä»¶                                 â”‚
â”‚  - QueryResult ç»„ä»¶                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTP/HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è·¯ç”±å±‚ (Express)                     â”‚
â”‚  - /api/chat/query (ä¸šåŠ¡æ¥å£)                    â”‚
â”‚  - /api/weda/* (Weda ä»£ç†)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ™ºèƒ½å†³ç­–å±‚ (LangChain.js)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. IntentClassifier (æ„å›¾åˆ†ç±»å™¨)         â”‚   â”‚
â”‚  â”‚     - LLM: é€šä¹‰åƒé—®/DeepSeek/OpenAI      â”‚   â”‚
â”‚  â”‚     - è¾“å…¥: ç”¨æˆ·æ¶ˆæ¯ + ä¸Šä¸‹æ–‡             â”‚   â”‚
â”‚  â”‚     - è¾“å‡º: IntentType + params          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. AgentRouter (Agent è·¯ç”±å™¨)            â”‚   â”‚
â”‚  â”‚     - æ ¹æ®æ„å›¾é€‰æ‹©å¯¹åº”çš„ Agent            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  3. ContextManager (ä¸Šä¸‹æ–‡ç®¡ç†)           â”‚   â”‚
â”‚  â”‚     - ä¼šè¯å†å²                            â”‚   â”‚
â”‚  â”‚     - ä¸Šä¸‹æ–‡è¡¥å…¨                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               æ‰§è¡Œå±‚ (Agents)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  DataExplorerAgent (æ•°æ®æŸ¥è¯¢)             â”‚   â”‚
â”‚  â”‚  - æŸ¥è¯¢ FlexDB é›†åˆ                       â”‚   â”‚
â”‚  â”‚  - æŸ¥è¯¢ MySQL è¡¨                          â”‚   â”‚
â”‚  â”‚  - æ•°æ®æ ¼å¼åŒ–                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  DocAssistantAgent (æ–‡æ¡£é—®ç­”)             â”‚   â”‚
â”‚  â”‚  - RAG æ£€ç´¢                               â”‚   â”‚
â”‚  â”‚  - æ–‡æ¡£ç”Ÿæˆ                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å…¶ä»– Agent (å¾…å®ç°)                      â”‚   â”‚
â”‚  â”‚  - FieldMutatorAgent                     â”‚   â”‚
â”‚  â”‚  - SchemaDesignerAgent                   â”‚   â”‚
â”‚  â”‚  - DataAnalyzerAgent                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åº•å±‚æœåŠ¡ (Clients)                      â”‚
â”‚  - CloudBaseClient (@tcb-manager/node)          â”‚
â”‚  - RAGService (ChromaDB + LangChain)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµï¼ˆæŸ¥è¯¢ç¤ºä¾‹ï¼‰

```
ç”¨æˆ·è¾“å…¥: "æŸ¥è¯¢ flexdb çš„ users è¡¨"
    â”‚
    â”œâ”€[1] å‰ç«¯: POST /api/chat/query
    â”‚         { message: "æŸ¥è¯¢ flexdb çš„ users è¡¨" }
    â”‚
    â”œâ”€[2] Controller: handleChatQuery()
    â”‚         â”œâ”€ ContextManager.enrichContext()
    â”‚         â”‚    â†’ è¡¥å…… envId, å†å²è®°å½•
    â”‚         â”‚
    â”‚         â”œâ”€ IntentClassifier.classify()
    â”‚         â”‚    â†’ LLM åˆ†ææ„å›¾
    â”‚         â”‚    â†’ è¾“å‡º: {
    â”‚         â”‚         type: "QUERY_DATABASE",
    â”‚         â”‚         params: {
    â”‚         â”‚           dbType: "flexdb",
    â”‚         â”‚           table: "users"
    â”‚         â”‚         }
    â”‚         â”‚       }
    â”‚         â”‚
    â”‚         â””â”€ AgentRouter.route()
    â”‚              â†’ è·¯ç”±åˆ° DataExplorerAgent
    â”‚
    â”œâ”€[3] DataExplorerAgent.execute()
    â”‚         â”œâ”€ å‚æ•°éªŒè¯å’Œè¡¥å…¨
    â”‚         â”œâ”€ CloudBaseClient.queryCollection()
    â”‚         â”‚    â†’ è°ƒç”¨ @tcb-manager/node
    â”‚         â”‚    â†’ è¿”å›æ•°æ®
    â”‚         â””â”€ æ ¼å¼åŒ–å“åº”
    â”‚
    â””â”€[4] è¿”å›å“åº”
          {
            type: "query_result",
            message: "å·²ä¸ºæ‚¨æŸ¥è¯¢ FlexDB çš„ users è¡¨ï¼Œå…± 120 æ¡æ•°æ®",
            data: [...],
            metadata: {
              dbType: "flexdb",
              table: "users",
              rowCount: 120,
              columns: ["id", "name", "email"],
              displayType: "document"
            },
            suggestions: ["ç­›é€‰æ•°æ®", "åˆ†æè¿™äº›æ•°æ®"]
          }
```

## ğŸ“¦ å®‰è£…å’Œå¯åŠ¨

### 1. å®‰è£…ä¾èµ–

```bash
cd backend
npm install
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` ä¸º `.env`ï¼Œå¡«å…¥é…ç½®ï¼š

```bash
cp .env.example .env
```

```env
# æœåŠ¡ç«¯å£
PORT=3001

# å¤§æ¨¡å‹é…ç½®
LLM_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
LLM_API_KEY=sk-xxx
LLM_MODEL=qwen3-max

# è…¾è®¯äº‘ CloudBase
TCB_SECRET_ID=AKIDxxx
TCB_SECRET_KEY=xxx
TCB_ENV_ID=xxx

# ChromaDBï¼ˆå¯é€‰ï¼Œç”¨äº RAGï¼‰
CHROMA_HOST=localhost
CHROMA_PORT=8000
```

### 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
npm run dev
```

æœåŠ¡å°†è¿è¡Œåœ¨ `http://localhost:3001`

## ğŸ”Œ API æ¥å£

### POST /api/chat/query

**è¯·æ±‚ä½“:**

```json
{
  "message": "æŸ¥è¯¢ flexdb çš„ users è¡¨",
  "context": {
    "envId": "xxx",
    "sessionId": "user-123",
    "history": []
  }
}
```

**å“åº”:**

```json
{
  "type": "query_result",
  "message": "å·²ä¸ºæ‚¨æŸ¥è¯¢ FlexDB çš„ users è¡¨ï¼Œå…± 120 æ¡æ•°æ®",
  "data": [
    { "id": 1, "name": "å¼ ä¸‰", "email": "zhang@example.com" },
    { "id": 2, "name": "æå››", "email": "li@example.com" }
  ],
  "metadata": {
    "dbType": "flexdb",
    "table": "users",
    "rowCount": 120,
    "columns": ["id", "name", "email"],
    "displayType": "document"
  },
  "suggestions": ["ç­›é€‰æ•°æ®", "åˆ†æè¿™äº›æ•°æ®", "å¯¼å‡ºä¸º Excel"]
}
```

## ğŸ¤– Agent è®¾è®¡

### DataExplorerAgentï¼ˆå·²å®ç°ï¼‰

**èŒè´£:**
- æŸ¥è¯¢ FlexDB é›†åˆ
- æŸ¥è¯¢ MySQL è¡¨
- æ•°æ®æ ¼å¼åŒ–å’Œæ¸²æŸ“

**æ”¯æŒçš„è¾“å…¥:**
- "æŸ¥è¯¢ users è¡¨"
- "æ˜¾ç¤º flexdb çš„ orders é›†åˆ"
- "åˆ—å‡º MySQL çš„ products è¡¨"

### DocAssistantAgentï¼ˆå ä½ï¼‰

**èŒè´£:**
- åŸºäº RAG çš„æ–‡æ¡£é—®ç­”
- SDK ä½¿ç”¨ç¤ºä¾‹ç”Ÿæˆ
- é”™è¯¯æ’æŸ¥å»ºè®®

**æ”¯æŒçš„è¾“å…¥:**
- "å¦‚ä½•è¿æ¥ MongoDB"
- "SDK åˆå§‹åŒ–æŠ¥é”™æ€ä¹ˆåŠ"
- "æ€ä¹ˆåˆ›å»ºæ•°æ®æ¨¡å‹"

### å…¶ä»– Agentï¼ˆå¾…å®ç°ï¼‰

- **FieldMutatorAgent**: ä¿®æ”¹å­—æ®µ
- **SchemaDesignerAgent**: åˆ›å»º/åˆ é™¤è¡¨
- **DataAnalyzerAgent**: æ•°æ®åˆ†æå’Œå¯¹æ¯”

## ğŸ¯ æ„å›¾åˆ†ç±»ï¼ˆIntentTypeï¼‰

| æ„å›¾ç±»å‹ | æè¿° | ç¤ºä¾‹ |
|---------|------|------|
| QUERY_DATABASE | æŸ¥è¯¢æ•°æ®åº“ | "æŸ¥è¯¢ users è¡¨" |
| MODIFY_FIELD | ä¿®æ”¹å­—æ®µ | "æŠŠ age å­—æ®µæ”¹æˆ bigint" |
| CREATE_COLLECTION | åˆ›å»ºè¡¨/é›†åˆ | "åˆ›å»ºä¸€ä¸ª products è¡¨" |
| DELETE_COLLECTION | åˆ é™¤è¡¨/é›†åˆ | "åˆ é™¤ temp è¡¨" |
| ANALYZE_DATA | æ•°æ®åˆ†æ | "ç»Ÿè®¡æ¯æœˆè®¢å•é‡" |
| DOC_QUESTION | æ–‡æ¡£é—®ç­” | "å¦‚ä½•è¿æ¥ MongoDB" |
| GENERAL_CHAT | æ™®é€šå¯¹è¯ | "ä½ å¥½" |

## ğŸ”„ å‰ç«¯å¯¹æ¥

### ä¿®æ”¹å‰ç«¯è¯·æ±‚ä»£ç 

åœ¨ `frontend/src/components/ChatArea/index.tsx` ä¸­ï¼š

```typescript
const handleSend = async () => {
  if (!inputValue.trim()) return;
  
  // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  const userMsg: ChatMessage = {
    id: messages.length + 1,
    type: 'user',
    content: inputValue,
  };
  
  setMessages(prev => [...prev, userMsg]);
  
  try {
    // è°ƒç”¨åç«¯ API
    const response = await fetch('http://localhost:3001/api/chat/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: inputValue,
        context: {
          envId: 'your-env-id', // ä»é…ç½®æˆ–ç™»å½•æ€è·å–
          sessionId: 'default',
        },
      }),
    });
    
    const result = await response.json();
    
    // æ·»åŠ  AI å›å¤
    const aiMsg: ChatMessage = {
      id: messages.length + 2,
      type: 'ai',
      content: result.message,
      data: result.data,
      metadata: result.metadata,
    };
    
    setMessages(prev => [...prev, aiMsg]);
    
    // è§¦å‘æ•°æ®å±•ç¤º
    onQuery?.(result);
  } catch (error) {
    console.error('Query error:', error);
    // é”™è¯¯å¤„ç†
  }
  
  setInputValue('');
};
```

### é…ç½® Vite ä»£ç†ï¼ˆå¯é€‰ï¼‰

åœ¨ `frontend/vite.config.ts` ä¸­æ·»åŠ ï¼š

```typescript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:3001',
        changeOrigin: true,
      },
    },
  },
});
```

è¿™æ ·å‰ç«¯å¯ä»¥ç›´æ¥è°ƒç”¨ `/api/chat/query`ï¼Œæ— éœ€æŒ‡å®šå®Œæ•´ URLã€‚

## ğŸš€ æœªæ¥è§„åˆ’

### çŸ­æœŸï¼ˆMVPï¼‰
- [x] IntentClassifier æ„å›¾åˆ†ç±»
- [x] DataExplorerAgent æŸ¥è¯¢åŠŸèƒ½
- [ ] å‰ç«¯æ•°æ®å±•ç¤ºä¼˜åŒ–
- [ ] é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### ä¸­æœŸ
- [ ] RAG æ–‡æ¡£é—®ç­”ï¼ˆChromaDB + LangChainï¼‰
- [ ] å¤šè¡¨ JOIN å’ŒèšåˆæŸ¥è¯¢
- [ ] æ•°æ®åˆ†æå’Œ AI æ€»ç»“
- [ ] ä¼šè¯ä¸Šä¸‹æ–‡æŒä¹…åŒ–ï¼ˆRedisï¼‰

### é•¿æœŸ
- [ ] å¤š Agent åä½œï¼ˆLangGraphï¼‰
- [ ] SQL å®‰å…¨ç™½åå•å’Œå®¡è®¡
- [ ] æ™ºèƒ½ç´¢å¼•æ¨è
- [ ] æ•°æ®å¯è§†åŒ–ï¼ˆEChartsï¼‰
- [ ] æ“ä½œå›æ»šå’Œå˜æ›´å®¡è®¡

## ğŸ“ å¼€å‘æ³¨æ„äº‹é¡¹

1. **å®‰å…¨æ€§**: 
   - SQL æ³¨å…¥é˜²æŠ¤ï¼ˆä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼‰
   - æƒé™éªŒè¯ï¼ˆCloudBase Tokenï¼‰
   - æ•æ„Ÿæ“ä½œäºŒæ¬¡ç¡®è®¤

2. **æ€§èƒ½ä¼˜åŒ–**:
   - æŸ¥è¯¢ç»“æœåˆ†é¡µ
   - å¤§æ•°æ®é‡æµå¼è¿”å›
   - LLM å“åº”ç¼“å­˜

3. **å¯æ‰©å±•æ€§**:
   - Agent æ¨¡å—åŒ–è®¾è®¡
   - æ’ä»¶å¼ Agent æ³¨å†Œ
   - æ”¯æŒè‡ªå®šä¹‰ Skill

## ğŸ› è°ƒè¯•æŠ€å·§

```bash
# æŸ¥çœ‹å®Œæ•´æ—¥å¿—
npm run dev

# æµ‹è¯•å•ä¸ªæ¥å£
curl -X POST http://localhost:3001/api/chat/query \
  -H "Content-Type: application/json" \
  -d '{"message":"æŸ¥è¯¢ users è¡¨"}'

# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:3001/health
```
